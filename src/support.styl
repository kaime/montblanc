// @todo this is temporary
-regexp-version = '^[0-9]+(\.[0-9]+){0,2}$'

// Browser support
no-support = false

browsers = json('data/browsers.json', { hash: true })

supported-browsers = {
  'ie':                 8,
  'firefox':            20,
  'chrome':             12,
  'safari':             5,
  'opera':              12,
  'opera-mini':         no-support,
  'opera-mobile':       no-support,
  'android-chrome':     no-support,
  'android-browser':    no-support,
  'android-firefox':    no-support,
  'android-opera':      20,
  'ios-safari':         no-support,
  'blackberry-browser': no-support,
  'ie-mobile':          no-support
}

support()
  for arg in arguments
    arg = cast(arg, 'string')

    vendor = null
    version = null

    for a in split(' ', arg)
      if a in browsers
        vendor = a
      else if match(-regexp-version, a)
        version = cast(a, 'unit')
      else if a is not '>='
        // Only this operator is supported right now
        error('bad args')

    supported-browsers[vendor] = version

unsupport()
  for vendor in arguments
    arg = cast(arg, 'string')

    if vendor in browsers
      supported-browsers[vendor] = no-support

support-none()
  for vendor in supported-browsers
    supported-browsers[vendor] = no-support

-cmpver(a, b)
  aa = split('.', cast(a, 'string'))
  bb = split('.', cast(b, 'string'))
  la = length(aa)
  lb = length(bb)

  for v, i in aa
    v = 1 * v
    if i >= lb
      if v > 0
        return -1
    else
      vv = 1 * bb[i]
      if v > vv
        return -1
      else if v < vv
        return 1

  for v, i in bb
    v = 1 * v
    if i >= la
      if v > 0
        return 1
    else
      vv = 1 * aa[i]
      if v > vv
        return 1
      else if v < vv
        return -1

  return 0

/**
 * Checks the corresponding `support-for-{vendor}` variables.
 */
has-support()
  for arg in arguments
    arg = cast(arg, 'string')

    vendor = null
    version = null
    cmp = null

    for a in split(' ', arg)
      if a in browsers
        vendor = a
      else if match(-regexp-version, a)
        version = a
      else if a in ('<' '<=' '>' '>=')
        cmp = a
      else
        p(a)
        error('bad args')

    if vendor == null
      error('bad args')

    if cmp != null and version == null
      error('bad args')

    supported = supported-browsers[vendor]

    if version is null
      if supported != no-support
        return true
    else if supported is not no-support
      c = -cmpver(supported, version)
      if cmp is '>'
        return true if c < 0
      else if cmp is '>='
        return true if c <= 0
      else if cmp is '<'
        return true if c > 0
      else
        return true if c >= 0

  return false

support-for(vendor)
  vendor = cast(vendor, 'string')

  if vendor in browsers
    return supported-browsers[vendor]